version: '3.8'

services:
  # decision-support agent
  decision-support-agent:
    build: 
      context: ../../agents
      dockerfile: Dockerfile
    container_name: tdd_phase_4b-decision-support-agent
    environment:
      - "AGENT_NAME=decision-support"
      - "AGENT_TYPE=implementation"
      - "PROJECT_NAME=tdd_phase_4b"
      - "PROJECT_DESCRIPTION=TDD Phase 4b - Sequential Executive Dashboard with Unified Workspace"
      - "MAX_RESTARTS=5"
      - "TARGET_PASS_RATE=100"
      - "TEST_COMMAND=timeout 120  -- --passWithNoTests --forceExit --maxWorkers=2 || echo 'Tests: 0 passed, 0 failed'"
      - "AGENT_PROMPT_FILE=/prompts/phase4b-decision-support.md"
      - "DEBUG=${DEBUG:-false}"
      - "FRESH_START=${FRESH_START:-false}"
    volumes:
      - ../../volumes/tdd_phase_4b-workspace:/workspace:rw
      - ../../../docker/volumes/communication:/shared:rw
      - ../../agents/prompts:/prompts:ro
      - ./entrypoint.sh:/usr/local/bin/entrypoint-enhanced.sh:ro
      - ~/.claude:/home/agent/.claude:rw
      - ../../../docker/volumes/tdd_phase_4-decision-support:/reference/tdd_phase_4-decision-support:ro
      - ../../../docker/volumes/tdd_phase_4-executive-components:/reference/tdd_phase_4-executive-components:ro
      - ../../../docker/volumes/tdd_phase_4-executive-hooks:/reference/tdd_phase_4-executive-hooks:ro
      - ../../../docker/volumes/tdd_phase_4-executive-screens:/reference/tdd_phase_4-executive-screens:ro
      - ../../../docker/volumes/tdd_phase_4-cross-role-integration:/reference/tdd_phase_4-cross-role-integration:ro
    working_dir: /workspace
    entrypoint: ["/usr/local/bin/entrypoint-enhanced.sh"]
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER

  # executive-components agent
  executive-components-agent:
    build: 
      context: ../../agents
      dockerfile: Dockerfile
    container_name: tdd_phase_4b-executive-components-agent
    environment:
      - "AGENT_NAME=executive-components"
      - "AGENT_TYPE=implementation"
      - "PROJECT_NAME=tdd_phase_4b"
      - "PROJECT_DESCRIPTION=TDD Phase 4b - Sequential Executive Dashboard with Unified Workspace"
      - "MAX_RESTARTS=5"
      - "TARGET_PASS_RATE=100"
      - "TEST_COMMAND=timeout 120  -- --passWithNoTests --forceExit --maxWorkers=2 || echo 'Tests: 0 passed, 0 failed'"
      - "AGENT_PROMPT_FILE=/prompts/phase4b-executive-components.md"
      - "DEBUG=${DEBUG:-false}"
      - "FRESH_START=${FRESH_START:-false}"
      - "DEPENDS_ON=decision-support"
    volumes:
      - ../../volumes/tdd_phase_4b-workspace:/workspace:rw
      - ../../../docker/volumes/communication:/shared:rw
      - ../../agents/prompts:/prompts:ro
      - ./entrypoint.sh:/usr/local/bin/entrypoint-enhanced.sh:ro
      - ~/.claude:/home/agent/.claude:rw
      - ../../../docker/volumes/tdd_phase_4-decision-support:/reference/tdd_phase_4-decision-support:ro
      - ../../../docker/volumes/tdd_phase_4-executive-components:/reference/tdd_phase_4-executive-components:ro
      - ../../../docker/volumes/tdd_phase_4-executive-hooks:/reference/tdd_phase_4-executive-hooks:ro
      - ../../../docker/volumes/tdd_phase_4-executive-screens:/reference/tdd_phase_4-executive-screens:ro
      - ../../../docker/volumes/tdd_phase_4-cross-role-integration:/reference/tdd_phase_4-cross-role-integration:ro
    working_dir: /workspace
    entrypoint: ["/usr/local/bin/entrypoint-enhanced.sh"]
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
    depends_on:
      - decision-support-agent

  # executive-hooks agent
  executive-hooks-agent:
    build: 
      context: ../../agents
      dockerfile: Dockerfile
    container_name: tdd_phase_4b-executive-hooks-agent
    environment:
      - "AGENT_NAME=executive-hooks"
      - "AGENT_TYPE=implementation"
      - "PROJECT_NAME=tdd_phase_4b"
      - "PROJECT_DESCRIPTION=TDD Phase 4b - Sequential Executive Dashboard with Unified Workspace"
      - "MAX_RESTARTS=5"
      - "TARGET_PASS_RATE=100"
      - "TEST_COMMAND=timeout 120  -- --passWithNoTests --forceExit --maxWorkers=2 || echo 'Tests: 0 passed, 0 failed'"
      - "AGENT_PROMPT_FILE=/prompts/phase4b-executive-hooks.md"
      - "DEBUG=${DEBUG:-false}"
      - "FRESH_START=${FRESH_START:-false}"
      - "DEPENDS_ON=executive-components"
    volumes:
      - ../../volumes/tdd_phase_4b-workspace:/workspace:rw
      - ../../../docker/volumes/communication:/shared:rw
      - ../../agents/prompts:/prompts:ro
      - ./entrypoint.sh:/usr/local/bin/entrypoint-enhanced.sh:ro
      - ~/.claude:/home/agent/.claude:rw
      - ../../../docker/volumes/tdd_phase_4-decision-support:/reference/tdd_phase_4-decision-support:ro
      - ../../../docker/volumes/tdd_phase_4-executive-components:/reference/tdd_phase_4-executive-components:ro
      - ../../../docker/volumes/tdd_phase_4-executive-hooks:/reference/tdd_phase_4-executive-hooks:ro
      - ../../../docker/volumes/tdd_phase_4-executive-screens:/reference/tdd_phase_4-executive-screens:ro
      - ../../../docker/volumes/tdd_phase_4-cross-role-integration:/reference/tdd_phase_4-cross-role-integration:ro
    working_dir: /workspace
    entrypoint: ["/usr/local/bin/entrypoint-enhanced.sh"]
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
    depends_on:
      - executive-components-agent

  # executive-screens agent
  executive-screens-agent:
    build: 
      context: ../../agents
      dockerfile: Dockerfile
    container_name: tdd_phase_4b-executive-screens-agent
    environment:
      - "AGENT_NAME=executive-screens"
      - "AGENT_TYPE=implementation"
      - "PROJECT_NAME=tdd_phase_4b"
      - "PROJECT_DESCRIPTION=TDD Phase 4b - Sequential Executive Dashboard with Unified Workspace"
      - "MAX_RESTARTS=5"
      - "TARGET_PASS_RATE=100"
      - "TEST_COMMAND=timeout 120  -- --passWithNoTests --forceExit --maxWorkers=2 || echo 'Tests: 0 passed, 0 failed'"
      - "AGENT_PROMPT_FILE=/prompts/phase4b-executive-screens.md"
      - "DEBUG=${DEBUG:-false}"
      - "FRESH_START=${FRESH_START:-false}"
      - "DEPENDS_ON=executive-hooks"
    volumes:
      - ../../volumes/tdd_phase_4b-workspace:/workspace:rw
      - ../../../docker/volumes/communication:/shared:rw
      - ../../agents/prompts:/prompts:ro
      - ./entrypoint.sh:/usr/local/bin/entrypoint-enhanced.sh:ro
      - ~/.claude:/home/agent/.claude:rw
      - ../../../docker/volumes/tdd_phase_4-decision-support:/reference/tdd_phase_4-decision-support:ro
      - ../../../docker/volumes/tdd_phase_4-executive-components:/reference/tdd_phase_4-executive-components:ro
      - ../../../docker/volumes/tdd_phase_4-executive-hooks:/reference/tdd_phase_4-executive-hooks:ro
      - ../../../docker/volumes/tdd_phase_4-executive-screens:/reference/tdd_phase_4-executive-screens:ro
      - ../../../docker/volumes/tdd_phase_4-cross-role-integration:/reference/tdd_phase_4-cross-role-integration:ro
    working_dir: /workspace
    entrypoint: ["/usr/local/bin/entrypoint-enhanced.sh"]
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
    depends_on:
      - executive-hooks-agent

  # cross-role-integration agent
  cross-role-integration-agent:
    build: 
      context: ../../agents
      dockerfile: Dockerfile
    container_name: tdd_phase_4b-cross-role-integration-agent
    environment:
      - "AGENT_NAME=cross-role-integration"
      - "AGENT_TYPE=implementation"
      - "PROJECT_NAME=tdd_phase_4b"
      - "PROJECT_DESCRIPTION=TDD Phase 4b - Sequential Executive Dashboard with Unified Workspace"
      - "MAX_RESTARTS=5"
      - "TARGET_PASS_RATE=100"
      - "TEST_COMMAND=timeout 120  -- --passWithNoTests --forceExit --maxWorkers=2 || echo 'Tests: 0 passed, 0 failed'"
      - "AGENT_PROMPT_FILE=/prompts/phase4b-cross-role-integration.md"
      - "DEBUG=${DEBUG:-false}"
      - "FRESH_START=${FRESH_START:-false}"
      - "DEPENDS_ON=executive-screens"
    volumes:
      - ../../volumes/tdd_phase_4b-workspace:/workspace:rw
      - ../../../docker/volumes/communication:/shared:rw
      - ../../agents/prompts:/prompts:ro
      - ./entrypoint.sh:/usr/local/bin/entrypoint-enhanced.sh:ro
      - ~/.claude:/home/agent/.claude:rw
      - ../../../docker/volumes/tdd_phase_4-decision-support:/reference/tdd_phase_4-decision-support:ro
      - ../../../docker/volumes/tdd_phase_4-executive-components:/reference/tdd_phase_4-executive-components:ro
      - ../../../docker/volumes/tdd_phase_4-executive-hooks:/reference/tdd_phase_4-executive-hooks:ro
      - ../../../docker/volumes/tdd_phase_4-executive-screens:/reference/tdd_phase_4-executive-screens:ro
      - ../../../docker/volumes/tdd_phase_4-cross-role-integration:/reference/tdd_phase_4-cross-role-integration:ro
    working_dir: /workspace
    entrypoint: ["/usr/local/bin/entrypoint-enhanced.sh"]
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
    depends_on:
      - executive-screens-agent

  # Authentication Container
  tdd_phase_4b-auth:
    build:
      context: ../../agents
      dockerfile: Dockerfile
    container_name: tdd_phase_4b-auth
    environment:
      - "AGENT_NAME=auth"
      - "PROJECT_NAME=tdd_phase_4b"
    volumes:
      - ~/.claude:/home/agent/.claude:rw
    entrypoint: ["sleep", "infinity"]
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

  # Monitoring Container
  tdd_phase_4b-monitoring:
    build:
      context: ../../monitoring
      dockerfile: Dockerfile
    container_name: tdd_phase_4b-monitoring
    environment:
      - PORT=3016
      - PROJECT=tdd_phase_4b
    volumes:
      - ../../../docker/volumes/communication:/shared:rw
      - ../../monitoring/analyze-logs.sh:/app/analyze-logs.sh:ro
      - ~/.claude:/home/monitor/.claude:rw
    ports:
      - "3016:3016"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3016/health"]
      interval: 30s
      timeout: 10s
      retries: 3

# Networks and volumes
networks:
  default:
    name: tdd_phase_4b-network
    external: true

volumes:
  tdd_phase_4b-data:
    driver: local
