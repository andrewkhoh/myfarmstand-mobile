FROM node:18-alpine

# Install essentials
RUN apk add --no-cache git bash curl jq python3 py3-pip make g++ postgresql-client

# Install Claude Code CLI (same as Phase 1)
ARG CLAUDE_CODE_VERSION=latest
RUN npm install -g @anthropic-ai/claude-code@${CLAUDE_CODE_VERSION} || \
    (echo '#!/bin/bash' > /usr/local/bin/claude && \
     echo 'echo "Claude mock - will use real Claude when authenticated"' >> /usr/local/bin/claude && \
     echo 'tail -f /dev/null' >> /usr/local/bin/claude && \
     chmod +x /usr/local/bin/claude)

WORKDIR /workspace

# Copy package files and install
COPY package*.json ./
RUN npm ci

# Copy all source
COPY . .

# Create shared directories
RUN mkdir -p /shared/{logs,status,handoffs,blockers,progress,feedback,test-results,restart_counters}

# Environment
ENV NODE_ENV=test
ENV CI=true

# Copy entrypoint and prompts
COPY docker/agents/phase2-entrypoint-enhanced.sh /entrypoint.sh
COPY docker/agents/prompts /prompts
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
